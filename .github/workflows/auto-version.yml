name: ğŸš€ Auto Versioning System

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - '**.md'
      - '.github/**'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Type of version increment'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      description:
        description: 'Description for the update'
        required: false
        default: 'Auto update via GitHub Actions'
        type: string

env:
  NODE_VERSION: '18'
  REPO_NAME: 'gymtony-v2-working'
  GITHUB_USER: 'jstony2000'

jobs:
  auto-version:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: ğŸ–¥ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ”„ Update version automatically
      run: |
        # Determinar tipo de versiÃ³n
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION_TYPE="${{ github.event.inputs.version_type }}"
          DESCRIPTION="${{ github.event.inputs.description }}"
        else
          # Auto-detect desde commit message o usar patch por defecto
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          if [[ "$COMMIT_MSG" =~ \[major\]|\[breaking\] ]]; then
            VERSION_TYPE="major"
            DESCRIPTION="Breaking changes - Major release"
          elif [[ "$COMMIT_MSG" =~ \[minor\]|\[feature\] ]]; then
            VERSION_TYPE="minor"  
            DESCRIPTION="New features - Minor release"
          else
            VERSION_TYPE="patch"
            DESCRIPTION="Auto-patch update from commit"
          fi
        fi
        
        echo "ğŸ”„ Tipo de incremento: $VERSION_TYPE"
        echo "ğŸ“ DescripciÃ³n: $DESCRIPTION"
        
        # Ejecutar sistema de versionado
        node version-updater.js "$VERSION_TYPE" "$DESCRIPTION"
        
        # Verificar cambios
        if git diff --quiet; then
          echo "â„¹ï¸  No hay cambios para commitear"
          exit 0
        fi

    - name: ğŸ“‹ Configurar Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ env.GITHUB_USER }}/${{ env.REPO_NAME }}.git

    - name: ğŸ“ Commit y push cambios
      if: success()
      run: |
        # Obtener nueva versiÃ³n
        CURRENT_VERSION=$(node -e "console.log(require('./version.json').version)")
        CURRENT_BUILD=$(node -e "console.log(require('./version.json').build)")
        
        echo "ğŸ“Š Nueva versiÃ³n: $CURRENT_VERSION (Build $CURRENT_BUILD)"
        
        # Commit con mensaje descriptivo
        git add .
        git commit -m "ğŸ”– v$CURRENT_VERSION (Build $CURRENT_BUILD): Auto-versionado del sistema"
        
        # Push solo si hay cambios
        if ! git diff --staged --quiet; then
          git push origin main
          echo "âœ… Cambios pushados exitosamente"
        else
          echo "â„¹ï¸  No hay cambios para push"
        fi

    - name: ğŸŒ Verificar deployment
      if: success()
      run: |
        echo "ğŸš€ Deployment process initiated"
        echo "ğŸ“ URL de GitHub Pages: https://${{ env.GITHUB_USER }}.github.io/${{ env.REPO_NAME }}/"
        echo "â° GitHub Pages puede tardar 1-2 minutos en actualizarse"
        echo ""
        echo "ğŸ’¡ Sistema de versionado automÃ¡tico activado"
        echo "ğŸ·ï¸  Build number ahora coincide con la versiÃ³n patch"
        echo "ğŸ“ˆ ProgresiÃ³n: v2.4.7 (Build 7) â†’ v2.4.8 (Build 8) â†’ v2.4.9 (Build 9)"

  notify-success:
    if: success()
    needs: auto-version
    runs-on: ubuntu-latest
    steps:
      - name: âœ… Success notification
        run: |
          echo "ğŸ‰ Â¡SISTEMA DE VERSIONADO AUTOMÃTICO COMPLETADO!"
          echo "================================================"
          echo "ğŸ“ Nueva versiÃ³n desplegada automÃ¡ticamente"
          echo "ğŸ·ï¸  Build number sincronizado con versiÃ³n patch"
          echo "ğŸŒ GitHub Pages se actualizarÃ¡ en 1-2 minutos"
          echo "ğŸ“± La aplicaciÃ³n mostrarÃ¡ la nueva versiÃ³n en el tÃ­tulo"

  notify-failure:
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: âŒ Failure notification
        run: |
          echo "âŒ Error en el sistema de versionado automÃ¡tico"
          echo "=============================================="
          echo "ğŸ”§ Revisar los logs del workflow para detalles"
          echo "ğŸ’¡ El sistema se reintentarÃ¡ en el prÃ³ximo push"